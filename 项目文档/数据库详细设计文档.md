# 智慧校园助手 - 数据库详细设计文档

## 1. 数据库概述
本系统使用SQLite数据库，采用关系型数据库设计，包含用户管理、二手交易、聊天、餐饮订单和课程表五个主要模块。

## 2. 用户管理模块表设计

### 2.1 auth_user表（Django内置）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 用户ID |
| username | VARCHAR(150) | UNIQUE NOT NULL | 用户名 |
| password | VARCHAR(128) | NOT NULL | 密码哈希 |
| email | VARCHAR(254) | NOT NULL | 邮箱 |
| first_name | VARCHAR(150) | NOT NULL | 名 |
| last_name | VARCHAR(150) | NOT NULL | 姓 |
| is_staff | BOOLEAN | NOT NULL | 是否为管理员 |
| is_active | BOOLEAN | NOT NULL | 是否激活 |
| is_superuser | BOOLEAN | NOT NULL | 是否为超级用户 |
| last_login | DATETIME | NULL | 最后登录时间 |
| date_joined | DATETIME | NOT NULL | 注册时间 |

### 2.2 users_userprofile表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 资料ID |
| user_id | INTEGER | FOREIGN KEY (auth_user.id) | 用户ID |
| student_id | VARCHAR(20) | UNIQUE NOT NULL | 学号 |
| phone | VARCHAR(20) | NOT NULL | 手机号 |
| avatar | VARCHAR(255) | NULL | 头像URL |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

## 3. 二手交易模块表设计

### 3.1 secondhand_category表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 分类ID |
| name | VARCHAR(50) | UNIQUE NOT NULL | 分类名称 |
| created_at | DATETIME | NOT NULL | 创建时间 |

### 3.2 secondhand_product表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 商品ID |
| user_id | INTEGER | FOREIGN KEY (auth_user.id) | 发布者ID |
| name | VARCHAR(100) | NOT NULL | 商品名称 |
| description | TEXT | NOT NULL | 商品描述 |
| price | DECIMAL(10,2) | NOT NULL | 商品价格 |
| category_id | INTEGER | FOREIGN KEY (secondhand_category.id) NULL | 分类ID |
| status | INTEGER | NOT NULL DEFAULT 0 | 商品状态（0-在售，1-已售出） |
| images | JSON | NOT NULL DEFAULT [] | 商品图片URL列表 |
| contact | VARCHAR(100) | NOT NULL | 联系方式 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

### 3.3 secondhand_productfavorite表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 收藏ID |
| user_id | INTEGER | FOREIGN KEY (auth_user.id) | 用户ID |
| product_id | INTEGER | FOREIGN KEY (secondhand_product.id) | 商品ID |
| created_at | DATETIME | NOT NULL | 收藏时间 |
| UNIQUE (user_id, product_id) | | | 联合唯一约束 |

### 3.4 secondhand_productcomment表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 评论ID |
| user_id | INTEGER | FOREIGN KEY (auth_user.id) | 评论用户ID |
| product_id | INTEGER | FOREIGN KEY (secondhand_product.id) | 商品ID |
| content | TEXT | NOT NULL | 评论内容 |
| created_at | DATETIME | NOT NULL | 评论时间 |

### 3.5 secondhand_transaction表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 交易ID |
| product_id | INTEGER | FOREIGN KEY (secondhand_product.id) | 商品ID |
| buyer_id | INTEGER | FOREIGN KEY (auth_user.id) | 买家ID |
| seller_id | INTEGER | FOREIGN KEY (auth_user.id) | 卖家ID |
| status | INTEGER | NOT NULL DEFAULT 0 | 交易状态（0-待确认，1-已确认，2-已完成，3-已取消） |
| transaction_price | DECIMAL(10,2) | NOT NULL | 交易价格 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

### 3.6 secondhand_transactionreview表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 评价ID |
| transaction_id | INTEGER | FOREIGN KEY (secondhand_transaction.id) | 交易ID |
| reviewer_id | INTEGER | FOREIGN KEY (auth_user.id) | 评价者ID |
| reviewed_id | INTEGER | FOREIGN KEY (auth_user.id) | 被评价者ID |
| review_type | INTEGER | NOT NULL | 评价类型（0-买家评价卖家，1-卖家评价买家） |
| content | TEXT | NULL | 评价内容 |
| rating | INTEGER | NOT NULL | 评分（1-5） |
| created_at | DATETIME | NOT NULL | 评价时间 |
| UNIQUE (transaction_id, reviewer_id, reviewed_id) | | | 联合唯一约束 |

## 4. 聊天模块表设计

### 4.1 chat_conversation表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 对话ID |
| buyer_id | INTEGER | FOREIGN KEY (auth_user.id) | 买家ID |
| seller_id | INTEGER | FOREIGN KEY (auth_user.id) | 卖家ID |
| product_id | INTEGER | FOREIGN KEY (secondhand_product.id) | 关联商品ID |
| status | INTEGER | NOT NULL DEFAULT 0 | 对话状态（0-进行中，1-已结束） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| last_message | VARCHAR(255) | NULL | 最后一条消息内容 |
| unread_count | INTEGER | NOT NULL DEFAULT 0 | 未读消息数 |

### 4.2 chat_message表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 消息ID |
| conversation_id | INTEGER | FOREIGN KEY (chat_conversation.id) | 所属对话ID |
| sender_id | INTEGER | FOREIGN KEY (auth_user.id) | 发送者ID |
| receiver_id | INTEGER | FOREIGN KEY (auth_user.id) | 接收者ID |
| content | TEXT | NOT NULL | 消息内容 |
| message_type | INTEGER | NOT NULL DEFAULT 0 | 消息类型（0-文本，1-图片，2-文件） |
| status | INTEGER | NOT NULL DEFAULT 0 | 消息状态（0-未读，1-已读） |
| created_at | DATETIME | NOT NULL | 发送时间 |

## 5. 餐饮订单模块表设计

### 5.1 foodorder_restaurant表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 餐厅ID |
| name | VARCHAR(100) | NOT NULL | 餐厅名称 |
| description | TEXT | NULL | 餐厅描述 |
| address | VARCHAR(255) | NOT NULL | 餐厅地址 |
| phone | VARCHAR(20) | NULL | 联系电话 |
| opening_hours | VARCHAR(100) | NULL | 营业时间 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

### 5.2 foodorder_dish表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 菜品ID |
| restaurant_id | INTEGER | FOREIGN KEY (foodorder_restaurant.id) | 所属餐厅ID |
| name | VARCHAR(100) | NOT NULL | 菜品名称 |
| description | TEXT | NULL | 菜品描述 |
| price | DECIMAL(10,2) | NOT NULL | 菜品价格 |
| image | VARCHAR(255) | NULL | 菜品图片URL |
| category | VARCHAR(50) | NOT NULL | 菜品分类 |
| is_available | BOOLEAN | NOT NULL DEFAULT True | 是否可售 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

### 5.3 foodorder_order表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 订单ID |
| user_id | INTEGER | FOREIGN KEY (auth_user.id) | 用户ID |
| restaurant_id | INTEGER | FOREIGN KEY (foodorder_restaurant.id) | 餐厅ID |
| total_amount | DECIMAL(10,2) | NOT NULL | 订单总金额 |
| status | VARCHAR(20) | NOT NULL | 订单状态 |
| address | VARCHAR(255) | NOT NULL | 配送地址 |
| phone | VARCHAR(20) | NOT NULL | 联系电话 |
| remark | TEXT | NULL | 订单备注 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

### 5.4 foodorder_orderitem表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 订单项ID |
| order_id | INTEGER | FOREIGN KEY (foodorder_order.id) | 所属订单ID |
| dish_id | INTEGER | FOREIGN KEY (foodorder_dish.id) | 菜品ID |
| quantity | INTEGER | NOT NULL | 购买数量 |
| price | DECIMAL(10,2) | NOT NULL | 菜品单价 |
| created_at | DATETIME | NOT NULL | 创建时间 |

### 5.5 foodorder_dishreview表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 评价ID |
| dish_id | INTEGER | FOREIGN KEY (foodorder_dish.id) | 菜品ID |
| user_id | INTEGER | FOREIGN KEY (auth_user.id) | 用户ID |
| rating | INTEGER | NOT NULL | 评分（1-5） |
| content | TEXT | NULL | 评价内容 |
| created_at | DATETIME | NOT NULL | 评价时间 |

## 6. 课程表模块表设计

### 6.1 timetable_course表
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY | 课程ID |
| user_id | INTEGER | FOREIGN KEY (auth_user.id) | 用户ID |
| name | VARCHAR(100) | NOT NULL | 课程名称 |
| teacher | VARCHAR(50) | NULL | 教师姓名 |
| location | VARCHAR(100) | NULL | 上课地点 |
| start_time | TIME | NOT NULL | 开始时间 |
| end_time | TIME | NOT NULL | 结束时间 |
| day_of_week | INTEGER | NOT NULL | 星期几（1-7） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

## 7. 数据库关系图

```
用户管理
  ├── auth_user (1:N) secondhand_product
  ├── auth_user (1:1) users_userprofile
  └── auth_user (1:N) chat_message

二手交易
  ├── secondhand_category (1:N) secondhand_product
  ├── secondhand_product (1:N) secondhand_productcomment
  ├── secondhand_product (1:N) secondhand_productfavorite
  ├── secondhand_product (1:N) secondhand_transaction
  └── secondhand_transaction (1:N) secondhand_transactionreview

聊天
  ├── chat_conversation (1:N) chat_message
  ├── auth_user (1:N) chat_conversation (buyer)
  ├── auth_user (1:N) chat_conversation (seller)
  └── secondhand_product (1:N) chat_conversation

餐饮订单
  ├── foodorder_restaurant (1:N) foodorder_dish
  ├── foodorder_dish (1:N) foodorder_orderitem
  ├── foodorder_order (1:N) foodorder_orderitem
  └── auth_user (1:N) foodorder_order

课程表
  └── auth_user (1:N) timetable_course
```

## 8. 索引设计

### 8.1 二手交易模块索引
- **secondhand_product**：
  - 索引：(user_id, created_at DESC)
  - 索引：(category_id, status, created_at DESC)
- **secondhand_transaction**：
  - 索引：(buyer_id, created_at DESC)
  - 索引：(seller_id, created_at DESC)

### 8.2 聊天模块索引
- **chat_conversation**：
  - 索引：(buyer_id, updated_at DESC)
  - 索引：(seller_id, updated_at DESC)
- **chat_message**：
  - 索引：(conversation_id, created_at ASC)
  - 索引：(sender_id, created_at DESC)
  - 索引：(receiver_id, status, created_at DESC)

### 8.3 餐饮订单模块索引
- **foodorder_order**：
  - 索引：(user_id, created_at DESC)
  - 索引：(restaurant_id, created_at DESC)

## 9. 数据库优化建议

### 9.1 查询优化
1. 对于频繁的查询操作，添加适当的索引
2. 使用select_related和prefetch_related优化关联查询
3. 避免在查询中使用SELECT *，只查询需要的字段
4. 使用分页查询，限制返回结果数量

### 9.2 存储优化
1. 对于图片等大文件，使用外部存储，数据库只存储URL
2. 定期清理过期数据，如过期的订单、消息等
3. 对于频繁更新的字段，考虑使用缓存

### 9.3 性能优化
1. 使用连接池管理数据库连接
2. 考虑使用读写分离，提高查询性能
3. 对于复杂查询，考虑使用视图或存储过程
4. 定期优化数据库，如重建索引、分析表等

## 10. 数据安全

### 10.1 数据加密
1. 敏感数据如密码使用Django内置的哈希算法加密存储
2. 敏感信息传输使用HTTPS加密

### 10.2 数据备份
1. 定期备份数据库，确保数据安全
2. 备份文件存储在安全的位置

### 10.3 访问控制
1. 严格的数据库用户权限管理
2. 只授予必要的权限
3. 定期审计数据库访问日志

## 11. 数据库迁移和维护

1. 使用Django的迁移工具管理数据库结构变更
2. 定期执行数据库优化操作
3. 监控数据库性能，及时发现和解决问题
4. 建立数据库维护计划，包括备份、优化、清理等操作