# 智慧校园助手 - 软件详细设计文档

## 1. 系统架构

### 1.1 前端架构
```
前端应用
├── src/
│   ├── components/          # 公共组件
│   ├── views/               # 页面视图
│   │   ├── secondhand/      # 二手交易页面
│   │   ├── chat/            # 聊天页面
│   │   ├── foodorder/       # 餐饮订单页面
│   │   └── timetable/       # 课程表页面
│   ├── router/              # 路由配置
│   ├── store/               # Vuex状态管理
│   ├── api/                 # API请求封装
│   ├── utils/               # 工具函数
│   ├── App.vue              # 根组件
│   └── main.js              # 入口文件
└── public/                  # 静态资源
```

### 1.2 后端架构
```
后端应用
├── backend/
│   ├── smart_campus/        # 项目配置
│   ├── users/               # 用户管理应用
│   ├── secondhand/          # 二手交易应用
│   ├── chat/                # 聊天应用
│   ├── foodorder/           # 餐饮订单应用
│   ├── timetable/           # 课程表应用
│   └── manage.py            # 管理脚本
```

## 2. 二手交易模块详细设计

### 2.1 模型设计

#### 2.1.1 Category模型
- **表名**：secondhand_category
- **字段**：
  - id: 主键
  - name: 分类名称
  - created_at: 创建时间

#### 2.1.2 Product模型
- **表名**：secondhand_product
- **字段**：
  - id: 主键
  - user: 外键，关联User
  - name: 商品名称
  - description: 商品描述
  - price: 商品价格
  - category: 外键，关联Category
  - status: 商品状态（0-在售，1-已售出）
  - images: JSON数组，商品图片URL列表
  - contact: 联系方式
  - created_at: 创建时间
  - updated_at: 更新时间

#### 2.1.3 ProductFavorite模型
- **表名**：secondhand_productfavorite
- **字段**：
  - id: 主键
  - user: 外键，关联User
  - product: 外键，关联Product
  - created_at: 收藏时间

#### 2.1.4 ProductComment模型
- **表名**：secondhand_productcomment
- **字段**：
  - id: 主键
  - user: 外键，关联User
  - product: 外键，关联Product
  - content: 留言内容
  - created_at: 留言时间

#### 2.1.5 Transaction模型
- **表名**：secondhand_transaction
- **字段**：
  - id: 主键
  - product: 外键，关联Product
  - buyer: 外键，关联User
  - seller: 外键，关联User
  - status: 交易状态（0-待确认，1-已确认，2-已完成，3-已取消）
  - transaction_price: 交易价格
  - created_at: 创建时间
  - updated_at: 更新时间

#### 2.1.6 TransactionReview模型
- **表名**：secondhand_transactionreview
- **字段**：
  - id: 主键
  - transaction: 外键，关联Transaction
  - reviewer: 外键，关联User
  - reviewed: 外键，关联User
  - review_type: 评价类型（0-买家评价卖家，1-卖家评价买家）
  - content: 评价内容
  - rating: 评分（1-5）
  - created_at: 评价时间

### 2.2 前端组件设计

#### 2.2.1 商品列表组件
- **功能**：展示二手商品列表
- **文件路径**：`frontend/src/views/secondhand/List.vue`
- **核心逻辑**：
  - 调用API获取商品列表
  - 显示商品名称、价格、图片、发布者
  - 支持分类筛选
  - 商品点击跳转到详情页

#### 2.2.2 商品详情组件
- **功能**：展示商品详细信息
- **文件路径**：`frontend/src/views/secondhand/Detail.vue`
- **核心逻辑**：
  - 根据商品ID获取商品详情
  - 显示商品信息和发布者信息
  - 非商品发布者显示"联系卖家"按钮
  - 支持商品收藏和留言

#### 2.2.3 交易消息组件
- **功能**：展示交易相关的聊天消息
- **文件路径**：`frontend/src/views/secondhand/Messages.vue`
- **核心逻辑**：
  - 获取当前用户的所有交易对话
  - 显示对话列表，包含对方信息和最后一条消息
  - 点击对话跳转到聊天详情页

### 2.3 API设计

#### 2.3.1 商品相关API
- **获取商品列表**：`GET /api/secondhand/products/`
- **获取商品详情**：`GET /api/secondhand/products/<id>/`
- **创建商品**：`POST /api/secondhand/products/`
- **更新商品**：`PUT /api/secondhand/products/<id>/`
- **删除商品**：`DELETE /api/secondhand/products/<id>/`

#### 2.3.2 交易相关API
- **创建交易**：`POST /api/secondhand/transactions/`
- **获取交易列表**：`GET /api/secondhand/transactions/`
- **更新交易状态**：`PUT /api/secondhand/transactions/<id>/`

## 3. 聊天模块详细设计

### 3.1 模型设计

#### 3.1.1 Conversation模型
- **表名**：chat_conversation
- **字段**：
  - id: 主键
  - buyer: 外键，关联User
  - seller: 外键，关联User
  - product: 外键，关联Product
  - status: 对话状态（0-进行中，1-已结束）
  - created_at: 创建时间
  - updated_at: 更新时间
  - last_message: 最后一条消息
  - unread_count: 未读消息数

#### 3.1.2 Message模型
- **表名**：chat_message
- **字段**：
  - id: 主键
  - conversation: 外键，关联Conversation
  - sender: 外键，关联User
  - receiver: 外键，关联User
  - content: 消息内容
  - message_type: 消息类型（0-文本，1-图片，2-文件）
  - status: 消息状态（0-未读，1-已读）
  - created_at: 创建时间

### 3.2 前端组件设计

#### 3.2.1 聊天详情组件
- **功能**：显示聊天消息记录，支持发送消息
- **文件路径**：`frontend/src/views/chat/Detail.vue`
- **核心逻辑**：
  - 根据对话ID获取消息列表
  - 支持发送文本消息
  - 消息气泡样式优化，类似微信风格
  - 时间显示在消息气泡上方
  - 区分自己和对方的消息

### 3.3 API设计

#### 3.3.1 对话相关API
- **获取对话列表**：`GET /api/chat/conversations/`
- **获取对话详情**：`GET /api/chat/conversations/<id>/`
- **创建对话**：`POST /api/chat/conversations/`

#### 3.3.2 消息相关API
- **获取消息列表**：`GET /api/chat/messages/?conversation=<id>`
- **发送消息**：`POST /api/chat/messages/`
- **标记消息已读**：`PUT /api/chat/messages/<id>/read/`

## 4. 路由设计

### 4.1 前端路由
```javascript
// 二手交易路由
{
  path: '/secondhand',
  component: Layout,
  children: [
    { path: 'list', component: () => import('@/views/secondhand/List.vue') },
    { path: 'detail/:id', component: () => import('@/views/secondhand/Detail.vue') },
    { path: 'publish', component: () => import('@/views/secondhand/Publish.vue') },
    { path: 'my-products', component: () => import('@/views/secondhand/MyProducts.vue') },
    { path: 'favorites', component: () => import('@/views/secondhand/Favorites.vue') },
    { path: 'messages', component: () => import('@/views/secondhand/Messages.vue') }
  ]
},

// 聊天路由
{
  path: '/chat',
  component: Layout,
  children: [
    { path: 'list', component: () => import('@/views/chat/List.vue') },
    { path: 'detail/:id', component: () => import('@/views/chat/Detail.vue') }
  ]
}
```

### 4.2 后端路由
```python
# 二手交易路由
urlpatterns = [
    path('products/', ProductListView.as_view(), name='product-list'),
    path('products/<int:pk>/', ProductDetailView.as_view(), name='product-detail'),
    path('transactions/', TransactionListView.as_view(), name='transaction-list'),
    # 其他路由...
]

# 聊天路由
urlpatterns = [
    path('conversations/', ConversationListView.as_view(), name='conversation-list'),
    path('messages/', MessageListView.as_view(), name='message-list'),
    # 其他路由...
]
```

## 5. 核心功能实现

### 5.1 商品发布者显示
- **实现位置**：`frontend/src/views/secondhand/List.vue`
- **核心代码**：
  ```vue
  <div class="product-seller">{{ product.user?.username || product.seller }}</div>
  ```

### 5.2 联系卖家按钮控制
- **实现位置**：`frontend/src/views/secondhand/Detail.vue`
- **核心逻辑**：
  - 获取当前登录用户
  - 比较当前用户与商品发布者
  - 非本人显示联系按钮
  ```vue
  <el-button 
    v-if="currentUser && currentUser.id !== product.user.id" 
    type="primary" 
    @click="contactSeller"
  >
    联系卖家
  </el-button>
  ```

### 5.3 聊天UI优化
- **实现位置**：`frontend/src/views/chat/Detail.vue`
- **核心优化**：
  - 消息气泡样式修改
  - 时间显示在消息气泡上方
  - 添加阴影效果
  - 区分自己和对方的消息位置
  ```vue
  <div 
    v-for="message in messages" 
    :key="message.id" 
    class="message-item"
    :class="{ 'my-message': message.sender.id === currentUser.id }"
  >
    <div class="message-time">{{ formatTime(message.created_at) }}</div>
    <div class="message-bubble">{{ message.content }}</div>
  </div>
  ```

## 6. 数据流程

### 6.1 商品浏览流程
1. 前端调用`GET /api/secondhand/products/`获取商品列表
2. 后端查询数据库，返回商品数据
3. 前端渲染商品列表，显示商品名称、价格、图片、发布者
4. 用户点击商品，跳转到详情页
5. 前端调用`GET /api/secondhand/products/<id>/`获取商品详情
6. 后端查询数据库，返回商品详细信息
7. 前端渲染商品详情，显示完整信息

### 6.2 聊天流程
1. 用户在商品详情页点击"联系卖家"
2. 前端调用`POST /api/chat/conversations/`创建对话（如果不存在）
3. 后端创建对话记录，返回对话ID
4. 前端跳转到聊天详情页
5. 前端调用`GET /api/chat/messages/?conversation=<id>`获取历史消息
6. 后端返回消息列表
7. 前端渲染消息记录
8. 用户发送消息，前端调用`POST /api/chat/messages/`
9. 后端保存消息，返回消息对象
10. 前端更新消息列表

## 7. 异常处理

### 7.1 前端异常处理
- **API请求异常**：使用axios拦截器统一处理
- **页面加载异常**：添加加载状态和错误提示
- **数据渲染异常**：添加v-if判断，防止空数据导致的渲染错误

### 7.2 后端异常处理
- **请求验证**：使用Django REST Framework的序列化器验证
- **权限控制**：使用权限类限制API访问
- **异常捕获**：统一捕获和处理异常，返回标准错误格式

## 8. 性能优化

### 8.1 前端优化
- **组件懒加载**：使用动态import减少初始加载时间
- **图片懒加载**：商品图片按需加载
- **API请求缓存**：对频繁请求的数据进行缓存

### 8.2 后端优化
- **数据库索引**：在频繁查询的字段上添加索引
- **查询优化**：减少不必要的字段查询，使用select_related和prefetch_related优化关联查询
- **分页处理**：API返回结果分页，减少单次返回数据量

## 9. 安全性设计

### 9.1 认证授权
- **JWT认证**：所有API请求需要携带JWT令牌
- **权限控制**：基于角色的权限管理，确保用户只能访问自己的数据

### 9.2 数据安全
- **密码加密**：用户密码使用Django内置的密码哈希算法加密存储
- **防止SQL注入**：使用ORM和参数化查询，避免直接拼接SQL语句
- **防止XSS攻击**：前端渲染时进行HTML转义

### 9.3 敏感信息保护
- **API返回数据过滤**：不返回敏感字段，如密码、token等
- **HTTPS传输**：生产环境使用HTTPS加密传输数据
